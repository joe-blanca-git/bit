<nz-modal [(nzVisible)]="isVisible" [nzTitle]="title" [nzFooter]="footer" [nzWidth]="900" (nzOnCancel)="handleCancel()">
    <ng-container *nzModalContent>
        <form nz-form [formGroup]="financialForm" nzLayout="vertical">
            <div class="row">
                
                <div class="col-12 col-md-4">
                    <nz-form-item>
                        <nz-form-label nzRequired>Pessoa/Cliente</nz-form-label>
                        <nz-form-control>
                            <nz-select
                                formControlName="personId"
                                nzPlaceHolder="Pesquisar..."
                                nzShowSearch
                                nzServerSearch
                                [nzShowArrow]="false"
                                [nzFilterOption]="nzFilterOption"
                                (nzOnSearch)="search($event)"
                                [nzDropdownRender]="newPersonTemplate" 
                            >
                                <nz-option
                                *ngFor="let item of listPerson; trackBy: trackByItem"
                                [nzLabel]="item.name"
                                [nzValue]="item.id"
                                >
                                </nz-option>
                            </nz-select>

                            <ng-template #newPersonTemplate>
                                <nz-divider style="margin: 4px 0;"></nz-divider>
                                <div style="padding: 8px; cursor: pointer; color: #1890ff;" (click)="onOpenNewModal('newPerson')">
                                <i class="fa fa-square-plus"></i> Cadastrar
                                </div>
                            </ng-template>
                        </nz-form-control>
                    </nz-form-item>
                </div>

                <div class="col-12 col-md-4">
                    <nz-form-item>
                        <nz-form-label nzRequired>Origem</nz-form-label>
                        <nz-form-control>
                            <nz-select
                                formControlName="originId"
                                nzPlaceHolder="Pesquisar..."
                                nzShowSearch
                                nzServerSearch
                                [nzShowArrow]="false"
                                [nzFilterOption]="nzFilterOption"
                                (nzOnSearch)="search($event)"
                                [nzDropdownRender]="newOriginTemplate" 
                            >
                                <nz-option
                                *ngFor="let item of listOrigin; trackBy: trackByItem"
                                [nzLabel]="item.description"
                                [nzValue]="item.id"
                                >
                                </nz-option>
                            </nz-select>

                            <ng-template #newOriginTemplate>
                                <nz-divider style="margin: 4px 0;"></nz-divider>
                                <div style="padding: 8px; cursor: pointer; color: #1890ff;" (click)="onOpenNewModal('newOrigin')">
                                <i class="fa fa-square-plus"></i> Cadastrar
                                </div>
                            </ng-template>
                        </nz-form-control>
                    </nz-form-item>
                </div>

                <div class="col-6 col-md-4">
                    <nz-form-item>
                        <nz-form-label nzRequired>Categoria</nz-form-label>
                        <nz-form-control nzErrorTip="Selecione uma categoria.">
                            <nz-select formControlName="categoryId" nzPlaceHolder="Selecione...">
                                <nz-option [nzValue]="1" nzLabel="Alimentação"></nz-option>
                            </nz-select>
                        </nz-form-control>
                    </nz-form-item>
                </div>

                <div class="col-6 col-md-3">
                    <nz-form-item>
                        <nz-form-label>Pagamento</nz-form-label>
                        <nz-form-control>
                            <nz-switch formControlName="isPaid" nzCheckedChildren="Pago" nzUnCheckedChildren="Pendente"></nz-switch>
                        </nz-form-control>
                    </nz-form-item>
                </div>

                <div class="col-6 col-md-3">
                    <nz-form-item>
                        <nz-form-label nzRequired>Valor Total</nz-form-label>
                        <nz-form-control nzErrorTip="Informe o valor.">
                            <nz-input-number style="width: 100%" formControlName="totalAmount" [nzMin]="0.01"
                                [nzFormatter]="formatterReal" [nzParser]="parserReal"></nz-input-number>
                        </nz-form-control>
                    </nz-form-item>
                </div>

                <div class="col-6 col-md-3">
                    <nz-form-item>
                        <nz-form-label nzRequired>Nº de Parcelas</nz-form-label>
                        <nz-form-control nzErrorTip="Mínimo 1.">
                            <nz-input-number style="width: 100%" formControlName="installmentsCount"
                                [nzMin]="1"></nz-input-number>
                        </nz-form-control>
                    </nz-form-item>
                </div>

                <div class="col-12 col-md-3">
                    <nz-form-item>
                        <nz-form-label nzRequired>Vencimento (1ª parcela)</nz-form-label>
                        <nz-form-control nzErrorTip="Obrigatório.">
                            <nz-date-picker style="width: 100%" formControlName="firstDueDate"
                                nzFormat="dd/MM/yyyy"></nz-date-picker>
                        </nz-form-control>
                    </nz-form-item>
                </div>

                <div class="col-12 mt-4">
                    <nz-table #basicTable [nzData]="installments" [nzFrontPagination]="false" nzSize="small" [nzScroll]="{ y: '200px' }">
                        <thead>
                            <tr>
                                <th>Nº Parcela</th>
                                <th>Vencimento</th>
                                <th>Valor</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let data of basicTable.data">
                                <td>{{ data.number }}</td>
                                <td>{{ data.dueDate | format:'date' }}</td>
                                <td>{{ data.value | format:'currency' }}</td>
                            </tr>
                        </tbody>
                    </nz-table>
                </div>
            </div>
        </form>
    </ng-container>

    <ng-template #footer>
        <div class="d-flex justify-content-end gap-2">
          <button class="btn btn-outline-secondary btn-sm" (click)="handleCancel()">
                <i class="fa fa-xmark" aria-hidden="true"></i>&nbsp;
                <span>Cancelar</span>
            </button>
            <button class="btn btn-primary btn-sm" (click)="handleOk()">
                <i class="fa fa-check-double"></i>&nbsp;
                <span>Confirmar</span>
            </button>
        </div>
    </ng-template>
</nz-modal>

<app-new-person-full [isVisible]="isPersonModalVisible" (saved)="onPersonCreated($event)" (close)="onCloseNewModal('newPerson')"></app-new-person-full>
<app-new-financial-origin [isVisible]="isOriginModalVisible" (close)="onCloseNewModal('newOrigin')"></app-new-financial-origin>